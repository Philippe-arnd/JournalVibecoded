name: ðŸ”’ðŸš€ Security & Performance

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: security-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Fast checks run first (no dependencies)
  secret-scan:
    name: ðŸ” Secret Detection
    runs-on: ubuntu-latest
    timeout-minutes: 2
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml

  sast-scan:
    name: ðŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run Semgrep
        id: semgrep
        uses: semgrep/semgrep-action@v1
        continue-on-error: true
        with:
          config: >-
            p/security-audit
            p/javascript
            p/typescript
            p/react
            p/nodejs
            .semgrep.yml

      - name: Parse results
        if: always()
        id: result
        run: |
          EXIT_CODE="${{ steps.semgrep.outcome }}"

          if [ "$EXIT_CODE" == "success" ]; then
            echo "status=âœ… Pass" >> $GITHUB_OUTPUT
            echo "message=No vulnerabilities detected" >> $GITHUB_OUTPUT
            echo "details=" >> $GITHUB_OUTPUT
          else
            if [ -f semgrep.sarif ]; then
              ERRORS=$(jq '[.runs[].results[] | select(.level == "error")] | length' semgrep.sarif 2>/dev/null || echo "0")
              WARNINGS=$(jq '[.runs[].results[] | select(.level == "warning")] | length' semgrep.sarif 2>/dev/null || echo "0")

              if [ "$ERRORS" -gt 0 ]; then
                echo "status=âŒ Fail" >> $GITHUB_OUTPUT
                echo "message=$ERRORS critical issue(s)" >> $GITHUB_OUTPUT
                echo "details=Review security logs" >> $GITHUB_OUTPUT
              else
                echo "status=âš ï¸ Warning" >> $GITHUB_OUTPUT
                echo "message=$WARNINGS warning(s)" >> $GITHUB_OUTPUT
                echo "details=Non-blocking" >> $GITHUB_OUTPUT
              fi
            else
              echo "status=âŒ Fail" >> $GITHUB_OUTPUT
              echo "message=Scan failed" >> $GITHUB_OUTPUT
              echo "details=Check logs" >> $GITHUB_OUTPUT
            fi
          fi

    outputs:
      status: ${{ steps.result.outputs.status }}
      message: ${{ steps.result.outputs.message }}
      details: ${{ steps.result.outputs.details }}

  bundle-analysis:
    name: ðŸ“¦ Bundle Size
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.13.1'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        working-directory: client
        run: npm ci --prefer-offline --no-audit

      - name: Build client
        working-directory: client
        run: npm run build

      - name: Analyze bundle
        id: analyze
        working-directory: client
        run: |
          JS_SIZE=$(find dist/assets -name "*.js" -exec du -b {} + | awk '{sum+=$1} END {printf "%.0f", sum/1024}')
          CSS_SIZE=$(find dist/assets -name "*.css" -exec du -b {} + | awk '{sum+=$1} END {printf "%.0f", sum/1024}')
          JS_GZIP=$(find dist/assets -name "*.js" -exec gzip -c {} \; | wc -c | awk '{printf "%.0f", $1/1024}')
          CSS_GZIP=$(find dist/assets -name "*.css" -exec gzip -c {} \; | wc -c | awk '{printf "%.0f", $1/1024}')

          JS_BASE=543
          CSS_BASE=43

          JS_DIFF=$((JS_SIZE - JS_BASE))
          CSS_DIFF=$((CSS_SIZE - CSS_BASE))
          JS_PCT=$(awk "BEGIN {printf \"%.1f\", (($JS_SIZE - $JS_BASE) / $JS_BASE) * 100}")
          CSS_PCT=$(awk "BEGIN {printf \"%.1f\", (($CSS_SIZE - $CSS_BASE) / $CSS_BASE) * 100}")

          echo "js_size=$JS_SIZE" >> $GITHUB_OUTPUT
          echo "css_size=$CSS_SIZE" >> $GITHUB_OUTPUT
          echo "js_gzip=$JS_GZIP" >> $GITHUB_OUTPUT
          echo "css_gzip=$CSS_GZIP" >> $GITHUB_OUTPUT
          echo "js_diff=$JS_DIFF" >> $GITHUB_OUTPUT
          echo "css_diff=$CSS_DIFF" >> $GITHUB_OUTPUT
          echo "js_pct=$JS_PCT" >> $GITHUB_OUTPUT
          echo "css_pct=$CSS_PCT" >> $GITHUB_OUTPUT

          THRESHOLD=10
          if (( $(echo "$JS_PCT > $THRESHOLD" | bc -l) )) || (( $(echo "$CSS_PCT > $THRESHOLD" | bc -l) )); then
            echo "status=âš ï¸ Warning" >> $GITHUB_OUTPUT
            echo "message=Increased >10%" >> $GITHUB_OUTPUT
          elif (( JS_DIFF > 0 )) || (( CSS_DIFF > 0 )); then
            echo "status=ðŸ“ˆ Increased" >> $GITHUB_OUTPUT
            echo "message=Minor increase" >> $GITHUB_OUTPUT
          elif (( JS_DIFF < 0 )) || (( CSS_DIFF < 0 )); then
            echo "status=ðŸ“‰ Decreased" >> $GITHUB_OUTPUT
            echo "message=Size reduced" >> $GITHUB_OUTPUT
          else
            echo "status=âœ… Unchanged" >> $GITHUB_OUTPUT
            echo "message=No changes" >> $GITHUB_OUTPUT
          fi

    outputs:
      status: ${{ steps.analyze.outputs.status }}
      message: ${{ steps.analyze.outputs.message }}
      js_size: ${{ steps.analyze.outputs.js_size }}
      css_size: ${{ steps.analyze.outputs.css_size }}
      js_gzip: ${{ steps.analyze.outputs.js_gzip }}
      css_gzip: ${{ steps.analyze.outputs.css_gzip }}
      js_diff: ${{ steps.analyze.outputs.js_diff }}
      css_diff: ${{ steps.analyze.outputs.css_diff }}
      js_pct: ${{ steps.analyze.outputs.js_pct }}
      css_pct: ${{ steps.analyze.outputs.css_pct }}

  report:
    name: ðŸ“‹ Generate Report
    runs-on: ubuntu-latest
    needs: [secret-scan, sast-scan, bundle-analysis]
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: Generate report
        uses: actions/github-script@v7
        with:
          script: |
            const secretStatus = '${{ needs.secret-scan.result }}';
            const sastStatus = '${{ needs.sast-scan.result }}';
            const bundleStatus = '${{ needs.bundle-analysis.result }}';

            const sastOut = {
              status: '${{ needs.sast-scan.outputs.status }}',
              message: '${{ needs.sast-scan.outputs.message }}',
              details: '${{ needs.sast-scan.outputs.details }}'
            };

            const bundleOut = {
              status: '${{ needs.bundle-analysis.outputs.status }}',
              message: '${{ needs.bundle-analysis.outputs.message }}',
              js_size: '${{ needs.bundle-analysis.outputs.js_size }}',
              css_size: '${{ needs.bundle-analysis.outputs.css_size }}',
              js_gzip: '${{ needs.bundle-analysis.outputs.js_gzip }}',
              css_gzip: '${{ needs.bundle-analysis.outputs.css_gzip }}',
              js_diff: parseInt('${{ needs.bundle-analysis.outputs.js_diff }}'),
              css_diff: parseInt('${{ needs.bundle-analysis.outputs.css_diff }}'),
              js_pct: '${{ needs.bundle-analysis.outputs.js_pct }}',
              css_pct: '${{ needs.bundle-analysis.outputs.css_pct }}'
            };

            const hasFailure = [secretStatus, sastStatus].includes('failure');
            const hasWarning = bundleOut.status.includes('Warning') || sastOut.status.includes('Warning');

            let header = '## âœ… Security & Performance: All Clear';
            if (hasFailure) header = '## âŒ Security & Performance: Issues Found';
            else if (hasWarning) header = '## âš ï¸ Security & Performance: Warnings';

            // Compact status table
            let table = '| Check | Result |\n|:------|:-------|\n';
            table += `| ðŸ” **Secret Detection** | ${secretStatus === 'success' ? 'âœ… Pass' : 'âŒ Fail'} |\n`;
            table += `| ðŸ›¡ï¸ **Security Scan** | ${sastOut.status} â€¢ ${sastOut.message} |\n`;
            table += `| ðŸ“¦ **Bundle Size** | ${bundleOut.status} â€¢ ${bundleOut.message} |\n`;

            // Bundle details (only if changed)
            let bundleSection = '';
            if (bundleOut.js_diff !== 0 || bundleOut.css_diff !== 0) {
              const jsSign = bundleOut.js_diff > 0 ? '+' : '';
              const cssSign = bundleOut.css_diff > 0 ? '+' : '';

              bundleSection = `\n\n<details>\n<summary>ðŸ“¦ Bundle Size Details</summary>\n\n| Asset | Size | Gzipped | Change |\n|:------|-----:|--------:|:-------|\n`;
              bundleSection += `| JavaScript | ${bundleOut.js_size} KB | ${bundleOut.js_gzip} KB | ${jsSign}${bundleOut.js_diff} KB (${jsSign}${bundleOut.js_pct}%) |\n`;
              bundleSection += `| CSS | ${bundleOut.css_size} KB | ${bundleOut.css_gzip} KB | ${cssSign}${bundleOut.css_diff} KB (${cssSign}${bundleOut.css_pct}%) |\n\n`;
              bundleSection += `*Baselines: JS 543 KB, CSS 43 KB*\n</details>`;
            }

            // Action items (only if issues)
            let actions = '';
            if (hasFailure) {
              actions = '\n\n### ðŸš¨ Action Required\n\n';
              if (secretStatus === 'failure') {
                actions += `- [ ] **Fix secret detection**: Remove exposed credentials ([logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}))\n`;
              }
              if (sastStatus === 'failure') {
                actions += `- [ ] **Fix security issues**: ${sastOut.message} - ${sastOut.details}\n`;
              }
              actions += '\n> â›” **PR blocked**: Resolve security issues before merging';
            } else if (hasWarning && bundleOut.status.includes('Warning')) {
              actions = '\n\n### ðŸ’¡ Recommendation\n\n';
              actions += '> **Large bundle increase detected**. Consider:\n> - Using dynamic imports for code splitting\n> - Reviewing new dependencies for lighter alternatives\n> - Checking for duplicate dependencies in bundle\n';
            }

            const comment = `${header}\n\n${table}${bundleSection}${actions}\n\n---\n*Scan completed in [workflow #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;

            // Update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Security & Performance')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

            if (hasFailure) {
              core.setFailed('Security checks failed - see report above');
            }
