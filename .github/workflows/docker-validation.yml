name: üê≥ Docker Validation

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'Dockerfile'
      - '*/Dockerfile'
      - 'docker-compose*.yml'
      - '.dockerignore'
      - '*.Dockerfile'

concurrency:
  group: docker-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  docker-build:
    name: Build & Test Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.pull_request.draft == false

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create test .env
        run: |
          cat > .env << EOF
          DATABASE_URL=postgresql://postgres:test_password@postgres:5432/journal_test
          DATABASE_ADMIN_URL=postgresql://postgres:test_password@postgres:5432/journal_test
          BETTER_AUTH_SECRET=test-secret-key-for-docker-ci-minimum-32-characters-long
          BETTER_AUTH_URL=https://localhost:3000
          ANTHROPIC_API_KEY=sk-test-key
          RESEND_API_KEY=re_test_key
          TEST_USER_EMAIL=test@example.com
          TEST_USER_PASSWORD=TestPassword123!
          EOF

      - name: Build images (parallel)
        run: |
          docker compose build server &
          docker compose build client &
          wait

      - name: Start services & test
        run: |
          docker compose up -d
          sleep 10

          # Wait for server health
          for i in {1..30}; do
            if docker compose exec -T server wget -q -O- http://localhost:3000/health 2>/dev/null; then
              echo "‚úÖ Server healthy"
              docker compose down -v
              exit 0
            fi
            sleep 2
          done

          echo "‚ùå Health check failed"
          docker compose logs
          docker compose down -v
          exit 1

      - name: Comment result
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ Passed' : '‚ùå Failed';
            const comment = `## üê≥ Docker Validation: ${status}\n\n` +
              `Docker images ${status === '‚úÖ Passed' ? 'build successfully' : 'failed to build'}.` +
              `\n\n*Run [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;

            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(c => c.user.type === 'Bot' && c.body.includes('üê≥ Docker Validation'));

            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
