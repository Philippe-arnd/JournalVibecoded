name: üê≥ Docker Build Validation

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, ready_for_review]

# Ensures only one Docker validation runs per PR at a time
concurrency:
  group: docker-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  docker-build:
    name: Validate Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 20

    # Skip draft PRs
    if: github.event.pull_request.draft == false

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v6

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîß Create test .env file
        run: |
          cat > .env << EOF
          DATABASE_URL=postgresql://postgres:test_password@postgres:5432/journal_test
          DATABASE_ADMIN_URL=postgresql://postgres:test_password@postgres:5432/journal_test
          BETTER_AUTH_SECRET=test-secret-key-for-docker-ci-minimum-32-characters-long
          BETTER_AUTH_URL=https://localhost:3000
          ANTHROPIC_API_KEY=sk-test-key
          RESEND_API_KEY=re_test_key
          TEST_USER_EMAIL=test@example.com
          TEST_USER_PASSWORD=TestPassword123!
          EOF

      - name: üèóÔ∏è Build Server Image
        run: |
          docker compose build server
        continue-on-error: false

      - name: üèóÔ∏è Build Client Image
        run: |
          docker compose build client
        continue-on-error: false

      - name: üöÄ Test Docker Compose Up
        run: |
          echo "Starting services..."
          docker compose up -d

          echo "Waiting for services to be healthy..."
          sleep 10

          echo "Checking container status..."
          docker compose ps

          # Check if containers are running
          if ! docker compose ps | grep -q "Up"; then
            echo "::error::Containers failed to start"
            docker compose logs
            exit 1
          fi

      - name: üîç Test Server Health
        run: |
          echo "Testing server health endpoint..."
          max_attempts=30
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if docker compose exec -T server wget -q -O- http://localhost:3000/health 2>/dev/null; then
              echo "‚úÖ Server is healthy!"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts - Server not ready yet..."
            sleep 2
          done

          echo "::error::Server health check failed after $max_attempts attempts"
          docker compose logs server
          exit 1

      - name: üìã Show Container Logs (on failure)
        if: failure()
        run: |
          echo "=== Server Logs ==="
          docker compose logs server
          echo ""
          echo "=== Client Logs ==="
          docker compose logs client
          echo ""
          echo "=== PostgreSQL Logs ==="
          docker compose logs postgres

      - name: üßπ Cleanup
        if: always()
        run: docker compose down -v

      - name: ‚úÖ Docker Build Summary
        if: success()
        run: |
          echo "::notice::üéâ Docker validation passed!"
          echo "- ‚úÖ Server image builds successfully"
          echo "- ‚úÖ Client image builds successfully"
          echo "- ‚úÖ Docker Compose starts all services"
          echo "- ‚úÖ Server health check passes"

      - name: üí¨ Comment on PR (Success)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## üê≥ Docker Build Validation Passed!

            | Check | Status |
            |-------|--------|
            | üèóÔ∏è Server Image Build | ‚úÖ Passed |
            | üèóÔ∏è Client Image Build | ‚úÖ Passed |
            | üöÄ Docker Compose Up | ‚úÖ Passed |
            | üîç Server Health Check | ‚úÖ Passed |

            All Docker images build successfully and containers start correctly.

            _Validated in workflow run [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_`;

            // Find existing Docker validation comments
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('üê≥ Docker Build Validation')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: üí¨ Comment on PR (Failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ‚ùå Docker Build Validation Failed

            The Docker images or containers failed to build/start correctly. Please review the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

            Common issues:
            - Missing dependencies in Dockerfile
            - Invalid docker-compose.yml configuration
            - Port conflicts or networking issues
            - Environment variable issues

            _Failed in workflow run [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
