name: ðŸ”’ Dependency Review

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  dependency-review:
    name: Review Dependencies for Vulnerabilities
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸ”’ Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          # Fail on high/critical vulnerabilities
          fail-on-severity: high
          # Post summary in PR comments with detailed info
          comment-summary-in-pr: always
          # Scan package manifests
          base-ref: ${{ github.event.pull_request.base.sha }}
          head-ref: ${{ github.event.pull_request.head.sha }}
          # Show OpenSSF Scorecard ratings
          show-openssf-scorecard: true
          # Warn on these licenses (not fail)
          warn-only: true

      - name: ðŸ’¬ Comment on PR (Vulnerability Found)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸ”’ Security Alert: Vulnerabilities Detected

            High or critical severity vulnerabilities were found in the dependencies introduced by this PR.

            **Action Required:**
            - Review the dependency changes in this PR
            - Check the security tab for detailed vulnerability information
            - Update to patched versions or remove vulnerable dependencies
            - Consider using \`npm audit fix\` to automatically fix issues

            _See [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details._`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
