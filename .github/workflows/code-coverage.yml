name: üìä Code Coverage

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:17-alpine@sha256:bb377b7239d2774ac8cc76f481596ce96c5a6b5e9d141f6d0a0ee371a6e7c0f2
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: journal_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: |
          npm ci
          cd client && npm ci
          cd ../server && npm ci

      - name: üóÑÔ∏è Setup test database
        env:
          DATABASE_ADMIN_URL: postgresql://postgres:test_password@localhost:5432/journal_test
          BETTER_AUTH_SECRET: test-secret-key-for-coverage-minimum-32-characters
          BETTER_AUTH_URL: http://localhost:3000
        working-directory: server
        run: |
          echo "Creating restricted database user for RLS testing..."
          PGPASSWORD=test_password psql -h localhost -U postgres -d journal_test -c "CREATE USER app_user WITH PASSWORD 'app_password';"
          PGPASSWORD=test_password psql -h localhost -U postgres -d journal_test -c "GRANT CONNECT ON DATABASE journal_test TO app_user;"
          PGPASSWORD=test_password psql -h localhost -U postgres -d journal_test -c "GRANT USAGE ON SCHEMA public TO app_user;"
          PGPASSWORD=test_password psql -h localhost -U postgres -d journal_test -c "GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;"
          PGPASSWORD=test_password psql -h localhost -U postgres -d journal_test -c "GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO app_user;"
          PGPASSWORD=test_password psql -h localhost -U postgres -d journal_test -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_user;"
          PGPASSWORD=test_password psql -h localhost -U postgres -d journal_test -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO app_user;"

          echo "Running database migrations as admin..."
          npm run db:push

          echo "Applying RLS policies as admin..."
          npm run db:rls

      - name: üß™ Run Tests with Coverage
        env:
          DATABASE_URL: postgresql://app_user:app_password@localhost:5432/journal_test
          DATABASE_ADMIN_URL: postgresql://postgres:test_password@localhost:5432/journal_test
          BETTER_AUTH_SECRET: test-secret-key-for-coverage-minimum-32-characters
          BETTER_AUTH_URL: http://localhost:3000
          RESEND_API_KEY: re_test_key_for_ci
          NODE_ENV: test
        working-directory: server
        run: npx vitest run --coverage --coverage.reporter=json-summary --coverage.reporter=text

      - name: üìä Coverage Summary
        if: always()
        working-directory: server
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "## üìä Code Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat coverage/coverage-summary.json | jq -r '
              .total |
              "Lines:      \(.lines.pct)%\n" +
              "Statements: \(.statements.pct)%\n" +
              "Functions:  \(.functions.pct)%\n" +
              "Branches:   \(.branches.pct)%"
            ' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Coverage report not generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üí¨ Comment Coverage on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            let coverageComment = '## üìä Code Coverage Report\n\n';

            try {
              const coveragePath = path.join(process.cwd(), 'server', 'coverage', 'coverage-summary.json');
              const coverage = JSON.parse(fs.readFileSync(coveragePath, 'utf8'));
              const total = coverage.total;

              const getCoverageEmoji = (pct) => {
                if (pct >= 80) return '‚úÖ';
                if (pct >= 60) return '‚ö†Ô∏è';
                return '‚ùå';
              };

              coverageComment += '| Metric | Coverage | Status |\n';
              coverageComment += '|--------|----------|--------|\n';
              coverageComment += `| Lines | ${total.lines.pct}% | ${getCoverageEmoji(total.lines.pct)} |\n`;
              coverageComment += `| Statements | ${total.statements.pct}% | ${getCoverageEmoji(total.statements.pct)} |\n`;
              coverageComment += `| Functions | ${total.functions.pct}% | ${getCoverageEmoji(total.functions.pct)} |\n`;
              coverageComment += `| Branches | ${total.branches.pct}% | ${getCoverageEmoji(total.branches.pct)} |\n\n`;

              if (total.lines.pct < 60) {
                coverageComment += '‚ö†Ô∏è **Warning:** Code coverage is below 60%. Consider adding more tests.\n';
              }
            } catch (error) {
              coverageComment += '‚ö†Ô∏è Could not generate coverage report.\n';
              console.log('Error reading coverage:', error.message);
            }

            coverageComment += `\n_Generated in workflow run [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_`;

            // Find and update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('üìä Code Coverage Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: coverageComment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: coverageComment
              });
            }
