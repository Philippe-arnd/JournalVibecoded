name: ğŸ” PR Validation

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, ready_for_review]

# Ensures only one validation runs per PR at a time
concurrency:
  group: pr-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  validate:
    name: Run All Validations
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Skip draft PRs
    if: github.event.pull_request.draft == false

    permissions:
      contents: read
      pull-requests: write

    services:
      postgres:
        image: postgres:18-alpine@sha256:aa6eb304ddb6dd26df23d05db4e5cb05af8951cda3e0dc57731b771e0ef4ab29
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: journal_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.20.0'
          cache: 'npm'

      - name: ğŸ“¦ Install root dependencies
        run: npm ci

      - name: ğŸ“¦ Install client dependencies
        working-directory: client
        run: npm ci

      - name: ğŸ“¦ Install server dependencies
        working-directory: server
        run: npm ci

      - name: ğŸ” Run ESLint (Client)
        run: npm run lint:client
        continue-on-error: false

      - name: ğŸ—ï¸ Run Infrastructure Validation
        run: npm run test:infra
        continue-on-error: false

      - name: ğŸ—„ï¸ Setup test database
        env:
          DATABASE_ADMIN_URL: postgresql://postgres:test_password@localhost:5432/journal_test
          BETTER_AUTH_SECRET: test-secret-key-for-ci-minimum-32-characters
          BETTER_AUTH_URL: http://localhost:3000
        working-directory: server
        run: |
          echo "Creating restricted database user for RLS testing..."
          PGPASSWORD=test_password psql -h localhost -U postgres -d journal_test -c "CREATE USER app_user WITH PASSWORD 'app_password';"
          PGPASSWORD=test_password psql -h localhost -U postgres -d journal_test -c "GRANT CONNECT ON DATABASE journal_test TO app_user;"
          PGPASSWORD=test_password psql -h localhost -U postgres -d journal_test -c "GRANT USAGE ON SCHEMA public TO app_user;"
          PGPASSWORD=test_password psql -h localhost -U postgres -d journal_test -c "GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;"
          PGPASSWORD=test_password psql -h localhost -U postgres -d journal_test -c "GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO app_user;"
          PGPASSWORD=test_password psql -h localhost -U postgres -d journal_test -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_user;"
          PGPASSWORD=test_password psql -h localhost -U postgres -d journal_test -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO app_user;"

          echo "Running database migrations as admin..."
          npm run db:push

          echo "Applying RLS policies as admin..."
          npm run db:rls

      - name: ğŸ§ª Run Server Tests
        env:
          DATABASE_URL: postgresql://app_user:app_password@localhost:5432/journal_test
          DATABASE_ADMIN_URL: postgresql://postgres:test_password@localhost:5432/journal_test
          BETTER_AUTH_SECRET: test-secret-key-for-ci-minimum-32-characters
          BETTER_AUTH_URL: http://localhost:3000
          RESEND_API_KEY: re_test_key_for_ci
          NODE_ENV: test
        run: npm run test:server
        continue-on-error: false

      - name: ğŸ”’ Run RLS Policy Tests
        env:
          DATABASE_URL: postgresql://app_user:app_password@localhost:5432/journal_test
          DATABASE_ADMIN_URL: postgresql://postgres:test_password@localhost:5432/journal_test
          BETTER_AUTH_SECRET: test-secret-key-for-ci-minimum-32-characters
          BETTER_AUTH_URL: http://localhost:3000
          RESEND_API_KEY: re_test_key_for_ci
        working-directory: server
        run: npm run test:rls
        continue-on-error: false

      - name: ğŸ—ï¸ Build Client
        working-directory: client
        run: npm run build
        continue-on-error: false

      - name: ğŸ—ï¸ Build Server
        working-directory: server
        run: npm run build
        continue-on-error: false

      - name: âœ… Validation Summary
        if: success()
        run: |
          echo "::notice::ğŸ‰ All validation checks passed!"
          echo "- âœ… Linting"
          echo "- âœ… Infrastructure validation"
          echo "- âœ… Server tests"
          echo "- âœ… RLS policy tests"
          echo "- âœ… Client build"
          echo "- âœ… Server build"

      - name: ğŸ’¬ Comment on PR (Success)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## âœ… All Validation Checks Passed!

            | Check | Status |
            |-------|--------|
            | ğŸ” Linting | âœ… Passed |
            | ğŸ—ï¸ Infrastructure | âœ… Passed |
            | ğŸ§ª Server Tests | âœ… Passed |
            | ğŸ”’ RLS Policies | âœ… Passed |
            | ğŸ“¦ Client Build | âœ… Passed |
            | ğŸ“¦ Server Build | âœ… Passed |

            **Ready to merge!** This PR will auto-merge if approved.

            _Validated in workflow run [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: ğŸ’¬ Comment on PR (Failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## âŒ Validation Checks Failed

            Some checks did not pass. Please review the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

            Common fixes:
            - Run \`npm run lint:client\` locally to fix linting errors
            - Run \`npm run test:all\` locally to verify all tests pass
            - Check that \`docker-compose.yml\` has no fixed port mappings
            - Ensure Service Worker bypasses \`/api\` routes

            _Failed in workflow run [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
