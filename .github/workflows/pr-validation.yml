name: âœ… PR Validation

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  validation:
    if: github.event.pull_request.draft == false
    uses: Philippe-arnd/reusable-workflow-vibecoded/.github/workflows/reusable-pr-validation.yml@main
    with:
      node-version: '24.13.1'
      install-command: >-
        npm ci --prefer-offline &&
        npm ci --prefix client --prefer-offline &&
        npm ci --prefix server --prefer-offline
      cache-dependency-path: package-lock.json
      lint-command: npm run lint:client && npm run test:infra
      build-command: npm run build --prefix client && npm run build --prefix server
      test-command: cd server && npx vitest run --coverage --coverage.reporter=json-summary --coverage.reporter=text
      coverage-dir: server/coverage
      test-env: |
        BETTER_AUTH_SECRET=test-secret-key-for-ci-minimum-32-characters
        BETTER_AUTH_URL=http://localhost:3000
        RESEND_API_KEY=re_test_key_for_ci
        NODE_ENV=test
      postgres-db: journal_test
      postgres-admin-password: test_password
      app-user: app_user
      app-password: app_password
      db-migration-command: npm run --prefix server db:push
      db-rls-setup-command: npm run --prefix server db:rls
      rls-test-command: npm run --prefix server test:rls
