name: ü§ñ Auto-Merge PR

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  pull_request:
    types: [ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Auto-Merge if All Checks Pass
    runs-on: ubuntu-latest
    timeout-minutes: 5

    # Only run on PRs targeting main branch
    if: |
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.draft == false

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîç Check PR Status
        id: check-status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number || context.payload.pull_request.number,
            });

            // Get all status checks
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha,
            });

            // Get combined status (for older status API)
            const { data: status } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha,
            });

            console.log(`PR State: ${pr.state}`);
            console.log(`PR Mergeable: ${pr.mergeable}`);
            console.log(`PR Merged: ${pr.merged}`);
            console.log(`Check Runs: ${checks.check_runs.length}`);
            console.log(`Combined Status: ${status.state}`);

            // Check if all checks have passed
            const allChecksPassed = checks.check_runs.every(check =>
              check.status === 'completed' && check.conclusion === 'success'
            );

            const combinedStatusSuccess = status.state === 'success' || status.statuses.length === 0;

            console.log(`All Checks Passed: ${allChecksPassed}`);
            console.log(`Combined Status Success: ${combinedStatusSuccess}`);

            // Set outputs
            core.setOutput('ready_to_merge', allChecksPassed && combinedStatusSuccess && pr.mergeable && !pr.merged);
            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_title', pr.title);

            return {
              ready: allChecksPassed && combinedStatusSuccess && pr.mergeable && !pr.merged,
              pr_number: pr.number,
            };

      - name: üöÄ Auto-Merge PR
        if: steps.check-status.outputs.ready_to_merge == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.check-status.outputs.pr_number }};

            try {
              // Enable auto-merge with squash strategy
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: `${{ steps.check-status.outputs.pr_title }} (#${prNumber})`,
                commit_message: 'Auto-merged after all validation checks passed.',
              });

              console.log(`‚úÖ PR #${prNumber} has been auto-merged!`);

              // Comment on the PR
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ü§ñ **Auto-merged!**\n\nAll validation checks passed successfully. This PR has been automatically merged to \`main\`.\n\n‚úÖ Deployment to production will begin shortly via Coolify.`
              });
            } catch (error) {
              console.log(`‚ö†Ô∏è Could not auto-merge: ${error.message}`);

              // If auto-merge failed, comment on PR
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `‚ö†Ô∏è **Auto-merge attempted but failed**\n\nReason: ${error.message}\n\nPlease merge manually or check for conflicts.`
              });
            }

      - name: üìä Status Report
        if: steps.check-status.outputs.ready_to_merge != 'true'
        run: |
          echo "::notice::PR is not ready for auto-merge yet"
          echo "Possible reasons:"
          echo "- Some checks are still running"
          echo "- Some checks have failed"
          echo "- PR has merge conflicts"
          echo "- PR is already merged"
